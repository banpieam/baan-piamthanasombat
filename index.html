<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.25.1/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/Y9gWTt2V/image.jpg" alt="Logo" class="logo">
  </header>

  <div class="container">
    <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</h1>

    <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE -->
    <div id="profile" style="display: none; text-align: center;">
      <img id="profileImage" src="" alt="Profile Image" style="border-radius: 50%; width: 100px; height: 100px;">
      <p id="displayName"></p>
    </div>

    <form id="tenantForm">
      <label for="room">‡∏´‡πâ‡∏≠‡∏á:</label>
      <select id="room" name="room" required>
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
        <option value="Room101">Room101</option>
        <option value="Room102">Room102</option>
        <option value="Room201">Room201</option>
        <option value="Room202">Room202</option>
        <option value="Room203">Room203</option>
        <option value="Room204">Room204</option>
        <option value="Room205">Room205</option>
        <option value="Room206">Room206</option>
        <option value="Room301">Room301</option>
        <option value="Room302">Room302</option>
        <option value="Room303">Room303</option>
        <option value="Room304">Room304</option>
        <option value="Room305">Room305</option>
        <option value="Room306">Room306</option>
        <option value="Room307">Room307</option>
        <option value="Room308">Room308</option>
        <option value="Room401">Room401</option>
        <option value="Room402">Room402</option>
        <option value="Room403">Room403</option>
        <option value="Room404">Room404</option>
        <option value="Room405">Room405</option>
        <option value="Room406">Room406</option>
        <option value="Room407">Room407</option>
        <option value="Room408">Room408</option>
      </select>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          fetch("https://script.google.com/macros/s/AKfycbwiorOJLhxf1RKBwZQix8f11oV-84CAmjeOmHGySjcG8YrxlcqbqkVvDLt8l3FBAPeujQ/exec?action=getRegisteredRooms")
            .then(res => res.json())
            .then(data => {
              console.log("API Response:", data);
        
              let rooms = [];
              if (data.success && Array.isArray(data.rooms)) {
                rooms = data.rooms;
              } else if (Array.isArray(data)) {
                rooms = data;
              } else {
                console.warn("Unexpected format for registered rooms:", data);
                return;
              }
        
              console.log("Registered rooms to disable:", rooms);
        
              rooms.forEach(roomId => {
                 const option = document.querySelector(`#room option[value="${roomId}"]`);
                 if (option && option.value !== "") { // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á"
                     option.disabled = true;
                      option.textContent = option.textContent + " (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)";
             }
           });
            })
            .catch(err => console.error("Fetch error:", err));
        });
        </script>

      <label for="name">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
      <input type="text" id="name" name="name" required>

      <label for="idCard">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
      <input type="text" id="idCard" name="idCard" pattern="\d{13}" maxlength="13" required>

      <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label>
      <input type="tel" id="phone" name="phone" required>

      <input type="hidden" id="userId" name="userId">
      <input type="hidden" id="profileImageUrl" name="profileImageUrl">

      <button type="submit">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    async function initLiff() {
      const liffId = "2007964500-AZz0PrPo"; // ‚úÖ ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      await liff.init({ liffId });
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        const userId = profile.userId;

        // set ‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('userId').value = userId;
        document.getElementById('profileImage').src = profile.pictureUrl;
        document.getElementById('displayName').textContent = profile.displayName;
        document.getElementById('profileImageUrl').value = profile.pictureUrl;
        document.getElementById('profile').style.display = 'block';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        fetch(`https://script.google.com/macros/s/AKfycbwiorOJLhxf1RKBwZQix8f11oV-84CAmjeOmHGySjcG8YrxlcqbqkVvDLt8l3FBAPeujQ/exec?action=getTenantInfo&userId=${userId}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏õ info.html
              window.location.href = 'info.html';
            } else {
              // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á
              Swal.close();
              fetchRegisteredRooms();
            }
          })
          .catch(err => {
            console.error('Error:', err);
            Swal.close();
          });
      } else {
        liff.login();
        Swal.close();
      }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô disable ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    function fetchRegisteredRooms() {
  fetch('https://script.google.com/macros/s/AKfycbwiorOJLhxf1RKBwZQix8f11oV-84CAmjeOmHGySjcG8YrxlcqbqkVvDLt8l3FBAPeujQ/exec?action=getRegisteredRooms')
    .then(res => res.json())
    .then(registeredRooms => {
      const roomSelect = document.getElementById('room');

      Array.from(roomSelect.options).forEach(option => {
        if (option.value === "") return; // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á"

        if (registeredRooms.includes(option.value)) {
          // ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          option.disabled = true;
          option.style.color = "gray";
          option.style.opacity = "0.5";

          // ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ "(‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)" ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          if (!option.textContent.includes("(‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)")) {
            option.textContent = `${option.value} (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)`;
          }
        } else {
          // ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á
          option.disabled = false;
          option.style.color = "";
          option.style.opacity = "1";
          option.textContent = option.value; // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
        }
      });

      Swal.close();
    })
    .catch(err => {
      console.error('Error:', err);
      Swal.close();
    });
}

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ submit ‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('tenantForm').addEventListener('submit', function (event) {
  event.preventDefault();

  fetch('https://script.google.com/macros/s/.../exec?action=registerTenant', {
    method: 'POST',
    body: new FormData(document.getElementById('tenantForm'))
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
          text: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
          icon: 'success',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then(() => {
          document.getElementById('tenantForm').reset();
          fetchRegisteredRooms();
          window.location.href = 'info.html';
        });
      } else {
        Swal.fire({
          title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
          text: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
          icon: 'error',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
      }
    })
    .catch(err => {
      console.error('Error:', err);
    });
}); // üëà ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î function
